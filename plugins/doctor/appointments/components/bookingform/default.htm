<form
    data-request="onSaveBooking"
    data-request-validate
    data-request-success="handleSuccess"
    data-request-error="handleError"
    data-request-update="'@default': ''"
    data-request-flash
    data-request-data="{}">
    
    <div class="form-group">
        <label for="patient_name">Ваше имя</label>
        <input type="text" class="form-control" id="patient_name" name="patient_name" required>
    </div>

     <div class="form-group">
        <label for="email">Емайл</label>
        <input type="text" class="form-control" id="email" name="email" required>
    </div>

     <div class="form-group">
        <label for="phone">Телефон</label>
        <input type="text" class="form-control" id="phone" name="phone" required>
    </div>

    <div class="form-group">
        <label for="consultation_type_id">Тип консультации</label>
        <select class="form-control" id="consultation_type_id" name="consultation_type_id" required>
            <option value="">Выберите тип консультации</option>
            {% for id, name in consultationTypes %}
                <option value="{{ id }}">{{ name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="appointment_date">Дата приема</label>
        <input type="date" class="form-control" id="appointment_date" name="appointment_date" min="{{ 'now'|date('Y-m-d') }}" onchange="updateAvailableTimes()" required>
    </div>

    <div class="form-group">
        <label for="appointment_time">Время приема</label>
        <select class="form-control" id="appointment_time" name="appointment_time" required>
            <option value="">Выберите время</option>
            {% for time in availableTimes %}
                <option value="{{ time }}">{{ time }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="description">Описание</label>
        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
    </div>

    <div class="form-group">
        <div class="g-recaptcha" data-sitekey="{{ recaptcha_site_key }}" data-callback="onRecaptchaSuccess"></div>
        <div class="invalid-feedback" data-validate-error-for="g-recaptcha-response"></div>
    </div>

    <button type="submit" class="btn btn-primary" data-attach-loading>Записаться</button>
</form>

<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<script>
console.log('Script loaded');

function onRecaptchaSuccess(token) {
    console.log('reCAPTCHA verified with token:', token);
}

function handleSuccess(response) {
    console.log('Form submitted successfully:', response);
    // Очищаем форму
    document.querySelector('form').reset();
    // Очищаем reCAPTCHA
    grecaptcha.reset();
}

function handleError(response) {
    console.error('Form submission failed:', response);
    // Очищаем reCAPTCHA при ошибке
    grecaptcha.reset();
}

// Добавляем обработчики изменения полей для отладки
document.querySelectorAll('input, select, textarea').forEach(field => {
    field.addEventListener('change', function(e) {
        console.log(`Field ${this.name} changed to:`, this.value);
    });
});
</script>